syntax = "proto3";

package stack.authorization.v1;

import "google/protobuf/timestamp.proto";

// Authorization Service - RBAC, ABAC, and Zero Trust
service AuthorizationService {
  // RBAC operations
  rpc CheckPermission(CheckPermissionRequest) returns (CheckPermissionResponse);
  rpc GetUserPermissions(GetPermissionsRequest) returns (GetPermissionsResponse);
  rpc GetRolePermissions(GetRolePermissionsRequest) returns (GetPermissionsResponse);
  
  // ABAC evaluation
  rpc EvaluatePolicy(EvaluatePolicyRequest) returns (EvaluatePolicyResponse);
  
  // Zero Trust
  rpc EvaluateDeviceTrust(EvaluateDeviceTrustRequest) returns (EvaluateDeviceTrustResponse);
  rpc EvaluateContextualTrust(EvaluateContextualTrustRequest) returns (EvaluateContextualTrustResponse);
  
  // Role & Permission Management
  rpc AssignRole(AssignRoleRequest) returns (AssignRoleResponse);
  rpc RevokeRole(RevokeRoleRequest) returns (RevokeRoleResponse);
  rpc CreatePolicy(CreatePolicyRequest) returns (CreatePolicyResponse);
  
  // Health check
  rpc Health(HealthRequest) returns (HealthResponse);
}

// RBAC Checking
message CheckPermissionRequest {
  string user_id = 1;
  string resource = 2;
  string action = 3;
  map<string, string> context = 4;
}

message CheckPermissionResponse {
  bool allowed = 1;
  string reason = 2;
  repeated string required_roles = 3;
  string enforcement_point = 4; // "RBAC" | "ABAC" | "ZERO_TRUST"
}

// Get permissions
message GetPermissionsRequest {
  string user_id = 1;
}

message GetPermissionsResponse {
  repeated Permission permissions = 1;
  repeated Role roles = 2;
}

message GetRolePermissionsRequest {
  string role_id = 1;
}

message Permission {
  string id = 1;
  string resource = 2;
  string action = 3;
  string description = 4;
}

message Role {
  string id = 1;
  string name = 2;
  string description = 3;
  repeated Permission permissions = 4;
}

// ABAC (Attribute-Based Access Control)
message EvaluatePolicyRequest {
  string policy_id = 1;
  string subject_id = 2; // user ID
  string resource_id = 3;
  string action = 4;
  map<string, AttributeValue> subject_attributes = 5;
  map<string, AttributeValue> resource_attributes = 6;
  map<string, AttributeValue> environment_attributes = 7;
}

message AttributeValue {
  oneof value {
    string string_value = 1;
    int32 int_value = 2;
    double double_value = 3;
    bool bool_value = 4;
    google.protobuf.Timestamp timestamp_value = 5;
    StringArray string_array_value = 6;
  }
}

message StringArray {
  repeated string values = 1;
}

message EvaluatePolicyResponse {
  PolicyDecision decision = 1; // "ALLOW" | "DENY" | "CONDITIONAL"
  repeated string conditions = 2;
  string explanation = 3;
  float confidence_score = 4; // 0.0 - 1.0
}

enum PolicyDecision {
  DECISION_UNSPECIFIED = 0;
  ALLOW = 1;
  DENY = 2;
  CONDITIONAL = 3;
}

// Zero Trust - Device Trust
message EvaluateDeviceTrustRequest {
  string user_id = 1;
  string device_id = 2;
  string device_os = 3;
  string device_os_version = 4;
  bool device_encrypted = 5;
  bool antivirus_enabled = 6;
  bool firewall_enabled = 7;
  int64 device_age_days = 8;
  repeated string previous_logins_locations = 9;
  bool is_managed_device = 10;
}

message EvaluateDeviceTrustResponse {
  float trust_score = 1; // 0.0 - 1.0
  TrustLevel trust_level = 2;
  repeated TrustFactor factors = 3;
  bool requires_additional_verification = 4;
}

enum TrustLevel {
  TRUST_LEVEL_UNSPECIFIED = 0;
  FULLY_TRUSTED = 1;
  TRUSTED = 2;
  CONDITIONALLY_TRUSTED = 3;
  UNTRUSTED = 4;
}

message TrustFactor {
  string name = 1; // "device_age" | "os_patch_level" | "encryption"
  float score = 2;
  string status = 3; // "PASS" | "FAIL" | "WARNING"
}

// Zero Trust - Contextual Trust
message EvaluateContextualTrustRequest {
  string user_id = 1;
  string ip_address = 2;
  string country = 3;
  string city = 4;
  google.protobuf.Timestamp timestamp = 5;
  bool is_vpn = 6;
  bool is_proxy = 7;
  int32 days_since_last_auth = 8;
  string resource_sensitivity = 9; // "PUBLIC" | "INTERNAL" | "SENSITIVE" | "SECRET"
}

message EvaluateContextualTrustResponse {
  float trust_score = 1;
  TrustLevel trust_level = 2;
  repeated string required_mfa_methods = 3;
  bool requires_reauthentication = 4;
  int32 token_lifetime_minutes = 5;
}

// Role Assignment
message AssignRoleRequest {
  string user_id = 1;
  string role_id = 2;
  string organization_id = 3;
  google.protobuf.Timestamp valid_from = 4;
  google.protobuf.Timestamp valid_until = 5;
}

message AssignRoleResponse {
  bool success = 1;
  string assignment_id = 2;
}

message RevokeRoleRequest {
  string user_id = 1;
  string role_id = 2;
  string organization_id = 3;
}

message RevokeRoleResponse {
  bool success = 1;
}

// Policy Management
message CreatePolicyRequest {
  string name = 1;
  string description = 2;
  string policy_document = 3; // JSON policy
  PolicyType type = 4; // "RBAC" | "ABAC"
  bool enabled = 5;
}

message CreatePolicyResponse {
  bool success = 1;
  string policy_id = 2;
}

enum PolicyType {
  POLICY_TYPE_UNSPECIFIED = 0;
  RBAC = 1;
  ABAC = 2;
}

message HealthRequest {}
message HealthResponse {
  string status = 1;
}
